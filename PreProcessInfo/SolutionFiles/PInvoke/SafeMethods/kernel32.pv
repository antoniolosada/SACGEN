(%unit (%imports (%import "System") (%import "System.Runtime.InteropServices")) (%package "SafeNative") (%module "kernel32" (%public) (%method "GetPrivateProfileString" (%int) (%args (%variable (%byref) (%var "lpApplicationName") (%string)) (%variable (%byref) (%var "lpKeyName") (%string)) (%variable (%byref) (%var "lpDefault") (%string)) (%variable (%byref) (%var "lpReturnedString") (%string)) (%variable (%byval) (%var "nSize") (%int)) (%variable (%byref) (%var "lpFileName") (%string))) (%seq (%variable-list (%variable (%var "result" (%init-value 0)) (%int))) (%variable (%var "tmpPtr" (%init-value (%call (%id "Marshal.StringToHGlobalAnsi") (%param (%id "lpKeyName"))))) (%user-type "IntPtr")) (%try (%seq (%= (%id "result") (%call (%id "SAV_VB_NETSupport.UnsafeNative.kernel32.GetPrivateProfileString") (%param (%id "lpApplicationName") (%id "tmpPtr") (%id "lpDefault") (%id "lpReturnedString") (%id "nSize") (%id "lpFileName")))) (%= (%id "lpKeyName") (%call (%id "Marshal.PtrToStringAnsi") (%param (%id "tmpPtr"))))) (%finally (%seq (%call (%id "Marshal.FreeHGlobal") (%param (%id "tmpPtr")))))) (%return (%id "result"))) (%public))))